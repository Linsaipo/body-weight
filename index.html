<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>體重會員站（Google / Apple 登入 + 角色制）</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js 與日期 adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- Firebase SDK（v12.4.0）主要功能：Auth + Firestore -->
  <script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, OAuthProvider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, setDoc, getDoc, getDocs, where, updateDoc, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // === 1) 你的 Firebase 設定（已帶入你專案的值） ===
    const firebaseConfig = {
      apiKey: "AIzaSyD81Aw3raqUcG_EUl8_W_WG3bxcunfA9rQ",
      authDomain: "body-weight-39dfd.firebaseapp.com",
      projectId: "body-weight-39dfd",
      storageBucket: "body-weight-39dfd.appspot.com",
      messagingSenderId: "745642339903",
      appId: "1:745642339903:web:d570fce93146c8861c528a"
    };

    // 初始化（避免重複 init）
    let app; try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === 2) UI 元素 ===
    const el = {
      // header
      openRoleBtn: document.getElementById('openRoleBtn'),
      meName: document.getElementById('meName'),
      logoutBtn: document.getElementById('logoutBtn'),
      // auth buttons
      btnGoogle: document.getElementById('btnGoogle'),
      btnApple: document.getElementById('btnApple'),
      // sections
      authSection: document.getElementById('auth-section'),
      appSection: document.getElementById('app-section'),
      roleRouter: document.getElementById('role-router'),
      myRoleBadge: document.getElementById('myRoleBadge'),
      memberBind: document.getElementById('member-bind'),
      coachSection: document.getElementById('coach-section'),
      adminSection: document.getElementById('admin-section'),
      // member bind inputs
      coachNameInput: document.getElementById('coachNameInput'),
      coachEmailInput: document.getElementById('coachEmailInput'),
      consentChk: document.getElementById('consentChk'),
      bindCoachBtn: document.getElementById('bindCoachBtn'),
      skipBindBtn: document.getElementById('skipBindBtn'),
      // member entries
      date: document.getElementById('date'),
      weight: document.getElementById('weight'),
      bodyFat: document.getElementById('bodyFat'),
      muscle: document.getElementById('muscle'),
      waist: document.getElementById('waist'),
      note: document.getElementById('note'),
      saveBtn: document.getElementById('saveBtn'),
      tbody: document.getElementById('tbody'),
      chartCanvas: document.getElementById('weightChart'),
      emptyHint: document.getElementById('emptyHint'),
      trend7: document.getElementById('trend7'),
      trend30: document.getElementById('trend30'),
      // coach/admin tables
      coachMembersTbody: document.getElementById('coachMembersTbody'),
      pendingReqTbody: document.getElementById('pendingReqTbody'),
      usersAdminTbody: document.getElementById('usersAdminTbody'),
    };

    const ADMIN_EMAIL = 'linsaipo@gmail.com';

    // === 3) 登入提供者 ===
    const googleProvider = new GoogleAuthProvider();
    const appleProvider = new OAuthProvider('apple.com');
    appleProvider.addScope('email');
    appleProvider.addScope('name');

    el.btnGoogle?.addEventListener('click', async () => {
      try { await signInWithPopup(auth, googleProvider); }
      catch { await signInWithRedirect(auth, googleProvider); }
    });
    el.btnApple?.addEventListener('click', async () => {
      try { await signInWithPopup(auth, appleProvider); }
      catch { await signInWithRedirect(auth, appleProvider); }
    });
    getRedirectResult(auth).catch(() => {});
    el.logoutBtn?.addEventListener('click', async () => { await signOut(auth); });
    el.openRoleBtn?.addEventListener('click', (e) => {
      e.preventDefault(); el.roleRouter?.classList.remove('hidden'); el.roleRouter?.scrollIntoView({behavior:'smooth'});
    });

    // === 4) 共用工具 ===
    const show = (node, on=true) => node?.classList[on? 'remove':'add']('hidden');
    const fmtDate = (tsOrDate) => { const d = tsOrDate?.toDate?.() ? tsOrDate.toDate() : new Date(tsOrDate); if (Number.isNaN(d.getTime())) return ''; const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; };
    const safeNum = (v) => (v===null||v===undefined||v==='')? '': Number(v);
    const escapeHtml = (s) => s?.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    // === 5) 首頁圖表/表格 ===
    let weightChart = null, unsubscribeEntries = null;
    function renderChart(rows){
      const points = rows.map(r => ({ x: new Date(r.date?.toDate?.() ? r.date.toDate() : r.date), y: Number(r.weight) }));
      const data = { datasets: [{ label: '體重 (kg)', data: points, tension: 0.3, pointRadius: 3, borderWidth: 2, fill: false }] };
      const options = { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { autoSkip: true, maxTicksLimit: 8 } }, y: { title: { display: true, text: 'kg' }, ticks: { precision: 1 } } }, plugins: { legend: { display: true }, tooltip: { callbacks: { label: (ctx)=>`體重：${ctx.parsed.y} kg` } } } };
      if (weightChart) { weightChart.data = data; weightChart.update(); }
      else { weightChart = new Chart(el.chartCanvas.getContext('2d'), { type: 'line', data, options }); }
    }
    function renderTable(rows){
      el.tbody.innerHTML='';
      if (!rows.length) { show(el.emptyHint,true); return; }
      show(el.emptyHint,false);
      for (const r of rows){
        const tr = document.createElement('tr'); tr.className='border-b';
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${fmtDate(r.date)}</td>
          <td class="px-3 py-2 text-sm font-semibold">${safeNum(r.weight)}</td>
          <td class="px-3 py-2 text-sm">${safeNum(r.bodyFat)}</td>
          <td class="px-3 py-2 text-sm">${safeNum(r.muscle)}</td>
          <td class="px-3 py-2 text-sm">${safeNum(r.waist)}</td>
          <td class="px-3 py-2 text-sm">${escapeHtml(r.note||'')}</td>
          <td class="px-3 py-2 text-sm text-right"><button class="text-red-600 hover:underline" data-id="${r.id}">刪除</button></td>`;
        tr.querySelector('button')?.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const user = auth.currentUser; await deleteDoc(doc(db,'users', user.uid, 'entries', id));
        });
        el.tbody.appendChild(tr);
      }
    }
    function renderTrends(rows){
      if (!rows.length) { el.trend7.textContent='—'; el.trend30.textContent='—'; return; }
      const now=new Date(); const daysAgo=n=>new Date(now.getFullYear(),now.getMonth(),now.getDate()-n);
      const delta = (r)=>{ if(!r.length) return null; return +(Number(r[r.length-1].weight)-Number(r[0].weight)).toFixed(1); };
      const r7 = rows.filter(r => new Date(r.date?.toDate?.()?r.date.toDate():r.date) >= daysAgo(7));
      const r30= rows.filter(r => new Date(r.date?.toDate?.()?r.date.toDate():r.date) >= daysAgo(30));
      const d7 = delta(r7), d30 = delta(r30);
      el.trend7.textContent = d7===null? '—': (d7>0? `+${d7} kg` : `${d7} kg`);
      el.trend30.textContent = d30===null? '—': (d30>0? `+${d30} kg` : `${d30} kg`);
    }

    // === 6) 會員資料 CRUD ===
    el.saveBtn?.addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return alert('請先登入');
      const dateStr = el.date.value; const weightVal = parseFloat(el.weight.value);
      if (!dateStr) return alert('請選擇日期');
      if (Number.isNaN(weightVal)) return alert('請輸入體重');
      const entry = {
        date: new Date(dateStr+'T00:00:00'),
        weight: weightVal,
        bodyFat: el.bodyFat.value ? parseFloat(el.bodyFat.value) : null,
        muscle: el.muscle.value ? parseFloat(el.muscle.value) : null,
        waist: el.waist.value ? parseFloat(el.waist.value) : null,
        note: el.note.value?.trim() || '',
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db,'users', user.uid, 'entries'), entry);
      el.weight.value = el.bodyFat.value = el.muscle.value = el.waist.value = el.note.value = '';
    });

    function startEntriesFeed(uid){
      const qy = query(collection(db,'users', uid, 'entries'), orderBy('date','asc'));
      if (unsubscribeEntries) { unsubscribeEntries(); }
      unsubscribeEntries = onSnapshot(qy, (snap)=>{
        const rows = []; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
        renderTable(rows); renderChart(rows); renderTrends(rows);
      });
    }

    // === 7) 角色/教練綁定/管理 ===
    let unsubUsers=null, unsubReqs=null;

    async function ensureUserProfile(user){
      const uref = doc(db,'users', user.uid);
      const s = await getDoc(uref);
      const base = { email:user.email||'', displayName:user.displayName||'', role:'member', coachName:null, consent:false, createdAt: serverTimestamp(), subscription:false };
      if (!s.exists()){
        if ((user.email||'').toLowerCase()===ADMIN_EMAIL) base.role='admin';
        await setDoc(uref, base, { merge:true });
        return base;
      } else {
        const data = s.data();
        if ((user.email||'').toLowerCase()===ADMIN_EMAIL && data.role!=='admin'){
          await updateDoc(uref, { role:'admin' }); data.role='admin';
        }
        return data;
      }
    }

    function wireMemberBind(user){
      el.bindCoachBtn?.addEventListener('click', async ()=>{
        const name=(el.coachNameInput.value||'').trim(); const email=(el.coachEmailInput.value||'').trim();
        if(!name) return alert('請輸入教練姓名（或填 無）');
        if(!el.consentChk.checked) return alert('請先勾選人資料同意書');
        if(name==='無'){
          await updateDoc(doc(db,'users', user.uid), { coachName:'無', consent:true, consentAt: serverTimestamp() });
          show(el.memberBind,false); alert('已設定為無教練，可直接使用。'); return;
        }
        await addDoc(collection(db,'coach_requests'), {
          memberUid:user.uid, memberName:user.displayName||user.email||user.uid, memberEmail:user.email||'',
          coachName:name, coachEmail: email||'', consent:true, status:'pending', createdAt: serverTimestamp()
        });
        if (email){
          const subject=encodeURIComponent('【體重網站】會員綁定請求');
          const body=encodeURIComponent(`教練您好：\n\n我（${user.displayName||user.email||user.uid}）想綁定您為我的教練，請協助通知管理者審核。\n網站：linsaipo.github.io/body-weight\n`);
          window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        }
        alert('已送出綁定請求，待管理者審核。'); show(el.memberBind,false);
      });
      el.skipBindBtn?.addEventListener('click', ()=> show(el.memberBind,false));
    }

    function mountCoachView(profile, user){
      if (profile.role==='coach' || profile.role==='admin'){
        show(el.coachSection,true);
        const myName = profile.displayName || user.email || user.uid;
        const qMembers = query(collection(db,'users'), where('coachName','==', myName));
        if (unsubUsers) unsubUsers();
        unsubUsers = onSnapshot(qMembers, async snap => {
          el.coachMembersTbody.innerHTML='';
          for (const d of snap.docs){
            const u = d.data();
            const entriesRef = collection(db,'users', d.id, 'entries');
            const qLast = query(entriesRef, orderBy('date','desc'), limit(1));
            const last = await getDocs(qLast);
            let latestDate='—', latestWeight='—';
            last.forEach(ed=>{ const e = ed.data(); latestDate=fmtDate(e.date); latestWeight=e.weight; });
            const tr=document.createElement('tr'); tr.className='border-b';
            tr.innerHTML=`<td class='px-3 py-2'>${u.displayName||u.email||d.id}</td><td class='px-3 py-2'>${latestDate}</td><td class='px-3 py-2'>${latestWeight}</td>`;
            el.coachMembersTbody.appendChild(tr);
          }
        });
      } else { show(el.coachSection,false); }
    }

    function mountAdminView(profile){
      if (profile.role!=='admin'){ show(el.adminSection,false); return; }
      show(el.adminSection,true);
      // 待審請求
      const qPending = query(collection(db,'coach_requests'), where('status','==','pending'), orderBy('createdAt','asc'));
      if (unsubReqs) unsubReqs();
      unsubReqs = onSnapshot(qPending, snap => {
        el.pendingReqTbody.innerHTML='';
        snap.forEach(d=>{
          const r=d.data(); const tr=document.createElement('tr'); tr.className='border-b';
          const when = r.createdAt?.toDate?.()? r.createdAt.toDate().toLocaleString(): '—';
          tr.innerHTML = `<td class='px-3 py-2'>${when}</td><td class='px-3 py-2'>${r.memberName}</td><td class='px-3 py-2'>${r.coachName}</td><td class='px-3 py-2'><button class='approve px-3 py-1 rounded bg-emerald-600 text-white mr-2'>核准</button><button class='reject px-3 py-1 rounded bg-slate-200'>退回</button></td>`;
          tr.querySelector('.approve')?.addEventListener('click', async ()=>{
            await updateDoc(doc(db,'users', r.memberUid), { coachName:r.coachName, consent:true, consentAt: serverTimestamp() });
            await updateDoc(doc(db,'coach_requests', d.id), { status:'approved', handledAt: serverTimestamp() });
          });
          tr.querySelector('.reject')?.addEventListener('click', async ()=>{
            await updateDoc(doc(db,'coach_requests', d.id), { status:'rejected', handledAt: serverTimestamp() });
          });
          el.pendingReqTbody.appendChild(tr);
        });
      });
      // 使用者總覽
      const qAll = query(collection(db,'users'), orderBy('createdAt','asc'));
      onSnapshot(qAll, snap => {
        el.usersAdminTbody.innerHTML='';
        snap.forEach(dd=>{
          const u=dd.data(); const tr=document.createElement('tr'); tr.className='border-b';
          tr.innerHTML = `
            <td class='px-3 py-2'>${u.displayName||u.email||dd.id}</td>
            <td class='px-3 py-2'>${u.email||''}</td>
            <td class='px-3 py-2'>
              <select class='roleSel border rounded px-2 py-1'>
                <option value='member' ${u.role==='member'?'selected':''}>member</option>
                <option value='coach' ${u.role==='coach'?'selected':''}>coach</option>
                <option value='admin' ${u.role==='admin'?'selected':''}>admin</option>
              </select>
            </td>
            <td class='px-3 py-2'><input class='coachNameInput border rounded px-2 py-1 w-40' value='${u.coachName||''}' placeholder='教練姓名或 無' /></td>
            <td class='px-3 py-2'>${u.role==='coach'? `<label class='text-sm'><input type='checkbox' class='subChk' ${u.subscription?'checked':''}/> 有效</label>`: '—'}</td>
            <td class='px-3 py-2 text-right'><button class='saveBtn px-3 py-1 rounded bg-slate-900 text-white'>儲存</button></td>`;
          tr.querySelector('.saveBtn')?.addEventListener('click', async ()=>{
            const role=tr.querySelector('.roleSel').value;
            const coachName=tr.querySelector('.coachNameInput').value.trim()||null;
            const subEl=tr.querySelector('.subChk'); const subscription=subEl? subEl.checked:false;
            await updateDoc(doc(db,'users', dd.id), { role, coachName, subscription });
            alert('已儲存');
          });
          el.usersAdminTbody.appendChild(tr);
        });
      });
    }

    // === 8) 登入狀態監聽 ===
    onAuthStateChanged(auth, async (user)=>{
      // 清理監聽
      if (unsubUsers) { unsubUsers(); unsubUsers=null; }
      if (unsubReqs) { unsubReqs(); unsubReqs=null; }

      if (user){
        el.meName.textContent = user.displayName || user.email || '已登入';
        show(el.authSection,false); show(el.appSection,true); show(el.roleRouter,true);
        startEntriesFeed(user.uid);

        const profile = await ensureUserProfile(user);
        el.myRoleBadge.textContent = profile.role;

        // 綁定管理者建立使用者按鈕
        const createBtn = document.getElementById('createUserBtn');
        createBtn?.addEventListener('click', async ()=>{
          const uid = document.getElementById('newUserUid').value.trim();
          const email = document.getElementById('newUserEmail').value.trim();
          const name = document.getElementById('newUserName').value.trim();
          const role = document.getElementById('newUserRole').value;
          if (!uid) return alert('請填 UID');
          await setDoc(doc(db,'users', uid), { email, displayName: name, role, coachName: null, consent: false, subscription: false, createdAt: serverTimestamp() }, { merge: true });
          alert('已建立/更新使用者檔案');
        });

        // 會員需要先完成同意與教練選擇
        const needsBind = (profile.role==='member') && (!profile.consent || !profile.coachName);
        show(el.memberBind, needsBind);
        if (needsBind) wireMemberBind(user);

        mountCoachView(profile, user);
        mountAdminView(profile);
      } else {
        el.meName.textContent='';
        show(el.appSection,false); show(el.roleRouter,false); show(el.memberBind,false); show(el.coachSection,false); show(el.adminSection,false);
      }
    });

    // === 9) 預設日期填今天 ===
    document.addEventListener('DOMContentLoaded', () => {
      const t=new Date(); const yyyy=t.getFullYear(); const mm=String(t.getMonth()+1).padStart(2,'0'); const dd=String(t.getDate()).padStart(2,'0'); el.date.value = `${yyyy}-${mm}-${dd}`;
    });
  </script>
</head>
<body class="bg-slate-50 min-h-dvh">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg sm:text-xl font-bold">體重會員站（Google / Apple 登入 + 角色制）</h1>
      <div id="user-area" class="text-sm flex items-center gap-2">
        <a href="#role-router" id="openRoleBtn" class="px-3 py-1.5 rounded-lg bg-slate-100 border hover:bg-slate-200">角色/管理</a>
        <span id="meName" class="text-slate-600"></span>
        <button id="logoutBtn" class="hidden sm:inline-block px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:opacity-90">登出</button>
      </div>
    </div>
  </header>

  <!-- 未登入：提供 Google/Apple 登入 -->
  <section id="auth-section" class="max-w-md mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">選擇登入方式</h2>
      <div class="space-y-3">
        <button id="btnGoogle" class="w-full px-4 py-2 rounded-lg border bg-white hover:bg-slate-50 flex items-center justify-center gap-2">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5"/>
          <span>使用 Google 登入</span>
        </button>
        <button id="btnApple" class="w-full px-4 py-2 rounded-lg bg-black text-white hover:opacity-90 flex items-center justify-center gap-2">
          <svg viewBox="0 0 14 18" class="w-4 h-4 fill-current"><path d="M9.57.16a3.45 3.45 0 0 1-.82 2.56c-.7.83-1.86 1.49-3.01 1.4-.15-1.03.43-2.12 1.07-2.76A3.56 3.56 0 0 1 9.57.16Zm3.69 14.8c-.5 1.15-.74 1.65-1.38 2.66-1.1 1.7-2.65 3.83-4.56 3.86-1.06.02-1.79-.36-2.69-.36-.9 0-1.67.35-2.7.37-1.88.04-3.48-1.84-4.58-3.53C-.2 15.94-.64 13.4.5 11.47c.82-1.35 2.11-2.21 3.57-2.24 1.01-.02 1.95.4 2.66.4.7 0 1.85-.49 3.13-.42 1.26.08 2.41.52 3.18 1.33-2.8 1.6-2.35 5.79 1.22 6.42Z"/></svg>
          <span>使用 Apple 登入</span>
        </button>
        <p class="text-xs text-slate-500">提示：請先在 Firebase Authentication 中啟用對應提供者，並把 <code>linsaipo.github.io</code> 加到授權網域。</p>
      </div>
    </div>
  </section>

  <!-- 已登入主介面：左表單 + 右圖表/清單 -->
  <section id="app-section" class="hidden max-w-5xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左側：輸入表單 -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow p-6 sticky top-20">
          <h2 class="text-lg font-bold mb-4">新增身體數據</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm mb-1">日期</label>
              <input id="date" type="date" class="w-full px-3 py-2 rounded border" />
            </div>
            <div>
              <label class="block text-sm mb-1">體重 (kg)<span class="text-red-500"> *</span></label>
              <input id="weight" type="number" step="0.1" inputmode="decimal" class="w-full px-3 py-2 rounded border" placeholder="例如 72.3" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">體脂率 (%)</label>
                <input id="bodyFat" type="number" step="0.1" inputmode="decimal" class="w-full px-3 py-2 rounded border" />
              </div>
              <div>
                <label class="block text-sm mb-1">肌肉率 (%)</label>
                <input id="muscle" type="number" step="0.1" inputmode="decimal" class="w-full px-3 py-2 rounded border" />
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1">腰圍 (cm)</label>
              <input id="waist" type="number" step="0.1" inputmode="decimal" class="w-full px-3 py-2 rounded border" />
            </div>
            <div>
              <label class="block text-sm mb-1">備註</label>
              <textarea id="note" rows="2" class="w-full px-3 py-2 rounded border" placeholder="睡不飽、重訓日、外食等…"></textarea>
            </div>
            <button id="saveBtn" class="w-full mt-2 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:opacity-90">儲存</button>
          </div>
          <p class="text-xs text-slate-500 mt-3">資料會儲存在你的帳號底下（Firestore）。</p>
        </div>
      </div>

      <!-- 右側：圖表 + 清單 -->
      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl shadow p-6 h-[360px]">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold">體重走勢圖</h2>
            <div class="text-sm text-slate-600">近 7 天：<span id="trend7">—</span>，近 30 天：<span id="trend30">—</span></div>
          </div>
          <canvas id="weightChart" class="w-full h-full"></canvas>
        </div>

        <div class="bg-white rounded-2xl shadow overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-lg font-bold">歷史紀錄</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-left">
              <thead>
                <tr class="bg-slate-50 border-b text-sm">
                  <th class="px-3 py-2 font-semibold">日期</th>
                  <th class="px-3 py-2 font-semibold">體重 (kg)</th>
                  <th class="px-3 py-2 font-semibold">體脂率 (%)</th>
                  <th class="px-3 py-2 font-semibold">肌肉率 (%)</th>
                  <th class="px-3 py-2 font-semibold">腰圍 (cm)</th>
                  <th class="px-3 py-2 font-semibold">備註</th>
                  <th class="px-3 py-2"></th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
            <p id="emptyHint" class="px-6 py-6 text-sm text-slate-500">目前沒有資料，請從左側新增一筆紀錄。</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 角色切換的主容器 -->
  <section id="role-router" class="max-w-5xl mx-auto px-4 py-6 hidden">
    <div class="grid gap-4 sm:grid-cols-3">
      <div class="rounded-xl border bg-white p-4">
        <h3 class="font-bold mb-2">我的角色</h3>
        <p class="text-sm text-slate-600">管理者（linsaipo@gmail.com）可檢視與設定所有資料。</p>
        <div class="mt-3 text-sm">目前：<span id="myRoleBadge" class="inline-block rounded-lg bg-slate-100 px-2 py-1">…</span></div>
      </div>
      <div class="rounded-xl border bg-white p-4 sm:col-span-2">
        <h3 class="font-bold mb-2">快速導覽</h3>
        <div class="flex flex-wrap gap-2 text-sm">
          <a href="#member-bind" class="underline">會員綁定表單</a>
          <a href="#coach-section" class="underline">教練頁</a>
          <a href="#admin-section" class="underline">管理者頁</a>
        </div>
      </div>
    </div>
  </section>

  <!-- 會員：教練綁定 & 同意書 -->
  <section id="member-bind" class="max-w-2xl mx-auto px-4 py-6 hidden">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-bold mb-3">選擇教練與個資同意</h2>
      <p class="text-sm text-slate-600 mb-4">請輸入教練姓名（沒有教練請輸入「無」）。若提供 Email，系統會打開郵件通知草稿。</p>
      <div class="grid sm:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">教練姓名 <span class="text-red-500">*</span></label>
          <input id="coachNameInput" class="w-full px-3 py-2 rounded border" placeholder="例如：王小教／或填 無" />
        </div>
        <div>
          <label class="block text-sm mb-1">教練 Email（選填）</label>
          <input id="coachEmailInput" type="email" class="w-full px-3 py-2 rounded border" placeholder="例如：coach@example.com" />
        </div>
      </div>
      <label class="flex items-start gap-2 mt-4 text-sm">
        <input id="consentChk" type="checkbox" class="mt-1" />
        <span>我同意本網站蒐集與處理本人之身體數據（體重、體脂、腰圍等）以供教練追蹤與指導之用，並同意提供予指定教練與管理者查閱。</span>
      </label>
      <div class="flex gap-3 mt-4">
        <button id="bindCoachBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">送出並綁定</button>
        <button id="skipBindBtn" class="px-4 py-2 rounded-lg bg-slate-100">暫不綁定</button>
      </div>
      <p class="text-xs text-slate-500 mt-3">測試期間：綁定請求會寫入 Firestore 的 <code>coach_requests</code>，管理者審核後生效。若填了 Email，會開啟郵件草稿讓你寄給教練。</p>
    </div>
  </section>

  <!-- 教練頁：查看名單與數據概覽 -->
  <section id="coach-section" class="max-w-6xl mx-auto px-4 py-6 hidden">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-bold mb-4">我的會員</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead><tr class="bg-slate-50 border-b"><th class="px-3 py-2">會員</th><th class="px-3 py-2">最後紀錄日</th><th class="px-3 py-2">最新體重</th></tr></thead>
          <tbody id="coachMembersTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 管理員頁：全局檢視與審核 -->
  <section id="admin-section" class="max-w-6xl mx-auto px-4 py-6 hidden">
    <div class="bg-white rounded-2xl shadow p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">待審核：會員教練綁定請求</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead><tr class="bg-slate-50 border-b"><th class="px-3 py-2">時間</th><th class="px-3 py-2">會員</th><th class="px-3 py-2">教練姓名</th><th class="px-3 py-2">操作</th></tr></thead>
          <tbody id="pendingReqTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- 管理者：手動建立使用者（測試期） -->
    <div class="bg-white rounded-2xl shadow p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">快速建立使用者（測試期）</h2>
      <div class="grid md:grid-cols-4 gap-3 items-end">
        <div>
          <label class="block text-sm mb-1">UID（從 Authentication 複製）</label>
          <input id="newUserUid" class="w-full px-3 py-2 rounded border" placeholder="例：L1uz617cmIVZd4x1ghDwTLjht..." />
        </div>
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="newUserEmail" class="w-full px-3 py-2 rounded border" placeholder="user@example.com" />
        </div>
        <div>
          <label class="block text-sm mb-1">名稱（顯示用）</label>
          <input id="newUserName" class="w-full px-3 py-2 rounded border" placeholder="暱稱或姓名" />
        </div>
        <div>
          <label class="block text-sm mb-1">角色</label>
          <select id="newUserRole" class="w-full px-3 py-2 rounded border">
            <option value="member">member</option>
            <option value="coach">coach</option>
            <option value="admin">admin</option>
          </select>
        </div>
      </div>
      <button id="createUserBtn" class="mt-3 px-4 py-2 rounded bg-slate-900 text-white">建立</button>
      <p class="text-xs text-slate-500 mt-2">此動作僅建立 Firestore 的 <code>users/{UID}</code> 文件，不會新增 Firebase Authentication 帳號。</p>
    </div>

    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-bold mb-4">使用者總覽</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead><tr class="bg-slate-50 border-b"><th class="px-3 py-2">名稱</th><th class="px-3 py-2">Email</th><th class="px-3 py-2">角色</th><th class="px-3 py-2">教練姓名</th><th class="px-3 py-2">訂閱（教練）</th><th class="px-3 py-2">操作</th></tr></thead>
          <tbody id="usersAdminTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">Demo 站，Google / Apple 登入 + 角色制。請在 Firebase 啟用提供者、設定 Firestore 規則並發布。</footer>
</body>
</html>
