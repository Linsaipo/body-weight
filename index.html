<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PharmaFit 會員站（滑順動畫 + 點擊 Tooltip）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD81Aw3raqUcG_EUl8_W_WG3bxcunfA9rQ",
      authDomain: "body-weight-39dfd.firebaseapp.com",
      projectId: "body-weight-39dfd",
      storageBucket: "body-weight-39dfd.appspot.com",
      messagingSenderId: "745642339903",
      appId: "1:745642339903:web:d570fce93146c8861c528a"
    };

    let app; try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    function fmtDate(ts){ const d=ts?.toDate?.()?ts.toDate():new Date(ts);return isNaN(d)?'':d.toISOString().split('T')[0]; }

    function makeLineChart(ctx, datasetLabel, points, yUnit){
      const data = { datasets: [{
        label: datasetLabel,
        data: points,
        borderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 6,
        fill: false,
        borderColor: '#0d9488'
      }]};
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 900, easing: 'easeOutQuart' },
        interaction: { mode: 'nearest', intersect: false },
        elements: { line: { tension: 0.35 }, point: { hitRadius: 10 } },
        scales: {
          x: { type: 'time', time: { unit: 'day' } },
          y: { ticks: { callback: v => `${v}${yUnit||''}` } }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            enabled: true,
            callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y}${yUnit||''}` }
          }
        }
      };
      const chart = new Chart(ctx, { type: 'line', data, options });
      enableClickTooltip(chart);
      return chart;
    }

    function enableClickTooltip(chart){
      chart.canvas.addEventListener('click', e=>{
        const pts = chart.getElementsAtEventForMode(e,'nearest',{intersect:true},true);
        if(pts.length){
          chart.setActiveElements(pts);
          chart.tooltip.setActiveElements(pts,{x:e.offsetX,y:e.offsetY});
          chart.update();
        }else{
          chart.setActiveElements([]);
          chart.update();
        }
      });
    }

    let chartA=null, chartB=null;
    function startFeed(uid){
      const qy=query(collection(db,'users',uid,'entries'),orderBy('date','asc'));
      onSnapshot(qy,snap=>{
        const rows=[];snap.forEach(d=>rows.push({id:d.id,...d.data()}));
        renderCharts(rows);
        renderTable(rows);
      });
    }

    function renderCharts(rows){
      const ctxA=document.getElementById('chartA').getContext('2d');
      const ctxB=document.getElementById('chartB').getContext('2d');
      const toPts=f=>rows.filter(r=>r[f]!=null).map(r=>({x:new Date(r.date?.toDate?.()?r.date.toDate():r.date),y:parseFloat(r[f])}));
      if(chartA) chartA.destroy();
      if(chartB) chartB.destroy();
      chartA=makeLineChart(ctxA,'體重 (kg)',toPts('weight'),'kg');
      chartB=makeLineChart(ctxB,'腰圍 (cm)',toPts('waist'),'cm');
    }

    function renderTable(rows){
      const tb=document.getElementById('tbody');
      tb.innerHTML='';
      for(const r of rows){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='px-3 py-2 text-sm'>${fmtDate(r.date)}</td>
          <td class='px-3 py-2 text-sm'>${r.weight||''}</td>
          <td class='px-3 py-2 text-sm'>${r.waist||''}</td>
          <td class='px-3 py-2 text-sm'>${r.muscleMass||''}</td>`;
        tb.appendChild(tr);
      }
    }

    onAuthStateChanged(auth,user=>{ if(user) startFeed(user.uid); });
  </script>
</head>
<body class="max-w-4xl mx-auto p-6 bg-slate-50">
  <h1 class="text-2xl font-bold mb-4">PharmaFit（滑順動畫＋點擊 Tooltip）</h1>
  <div class="space-y-6">
    <div class="bg-white p-4 rounded-2xl shadow">
      <h2 class="font-semibold mb-2">身體組成</h2>
      <div class="h-[300px]"><canvas id="chartA"></canvas></div>
    </div>
    <div class="bg-white p-4 rounded-2xl shadow">
      <h2 class="font-semibold mb-2">身體量測</h2>
      <div class="h-[300px]"><canvas id="chartB"></canvas></div>
    </div>
    <div class="bg-white p-4 rounded-2xl shadow overflow-hidden">
      <h2 class="font-semibold mb-2">歷史紀錄</h2>
      <table class="min-w-full text-left text-sm">
        <thead class="bg-slate-100 border-b">
          <tr><th class="px-3 py-2">日期</th><th class="px-3 py-2">體重</th><th class="px-3 py-2">腰圍</th><th class="px-3 py-2">筋肉量</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>